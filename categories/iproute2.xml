<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="../assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Weird random notes (iproute2)</title><link>https://andir.github.io/</link><description></description><atom:link rel="self" type="application/rss+xml" href="https://andir.github.io/categories/iproute2.xml"></atom:link><language>en</language><lastBuildDate>Tue, 21 Jun 2016 15:55:20 GMT</lastBuildDate><generator>https://getnikola.com/</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>Using VRFs with linux</title><link>https://andir.github.io/posts/linux-ip-vrf/</link><dc:creator>Andreas Rammhold</dc:creator><description>&lt;div&gt;&lt;p&gt;Ever since I've heard about VRF support (or VRF-lite like it is called in Documentation/network/vrf.txt) I wanted to start tinkering with it.
Since the topic is currently only covered in the previously mentioned linux kernel documentation I thought it would be a good idea to post some notes.&lt;/p&gt;
&lt;p&gt;It basically boils down to adding an VRF interface and creating two &lt;cite&gt;ip rule&lt;/cite&gt;-entries.&lt;/p&gt;
&lt;p&gt;I'm using a local VM with ArchLinux since the VRF feature seems to require a rather recent kernel. My experience with kernels below version 4.6 weren't that great.&lt;/p&gt;
&lt;pre class="code shell"&gt;&lt;a name="rest_code_563941395f4640ccab55eb60cd53e2cb-1"&gt;&lt;/a&gt;$ ip -br link &lt;span class="c1"&gt;# this is where we are start off&lt;/span&gt;
&lt;a name="rest_code_563941395f4640ccab55eb60cd53e2cb-2"&gt;&lt;/a&gt;lo               UNKNOWN        00:00:00:00:00:00 &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt;
&lt;a name="rest_code_563941395f4640ccab55eb60cd53e2cb-3"&gt;&lt;/a&gt;ens3             DOWN           52:54:00:12:34:56 &amp;lt;BROADCAST,MULTICAST&amp;gt;
&lt;/pre&gt;&lt;p&gt;Now are adding a new interface named &lt;cite&gt;vrf-customer1&lt;/cite&gt; with the table &lt;cite&gt;customer1&lt;/cite&gt; assigned to it.
The table parameter is used to place routes from your devices within the VRF into the right routing table&lt;/p&gt;
&lt;pre class="code shell"&gt;&lt;a name="rest_code_406dc8c47f6e43c692a79a626a405aff-1"&gt;&lt;/a&gt;$ ip link add vrf-customer1 &lt;span class="nb"&gt;type&lt;/span&gt; vrf table customer1
&lt;a name="rest_code_406dc8c47f6e43c692a79a626a405aff-2"&gt;&lt;/a&gt;
&lt;a name="rest_code_406dc8c47f6e43c692a79a626a405aff-3"&gt;&lt;/a&gt;$ ip -d link show vrf-customer1 &lt;span class="c1"&gt;# verify that the interface indeed exists and has the correct table assigned to it&lt;/span&gt;
&lt;a name="rest_code_406dc8c47f6e43c692a79a626a405aff-4"&gt;&lt;/a&gt;4: vrf-customer1: &amp;lt;NOARP,MASTER&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc noop state DOWN mode DEFAULT group default qlen 1000
&lt;a name="rest_code_406dc8c47f6e43c692a79a626a405aff-5"&gt;&lt;/a&gt;    link/ether ca:22:59:ba:05:da brd ff:ff:ff:ff:ff:ff promiscuity 0
&lt;a name="rest_code_406dc8c47f6e43c692a79a626a405aff-6"&gt;&lt;/a&gt;    vrf table &lt;span class="m"&gt;100&lt;/span&gt; addrgenmode eui64
&lt;/pre&gt;&lt;p&gt;Next: redirect the traffic from and to the vrf to the customer1 table and verify the rules are indeed as expected:&lt;/p&gt;
&lt;pre class="code shell"&gt;&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-1"&gt;&lt;/a&gt;$ ip -4 rule add oif vrf-customer1 lookup customer1
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-2"&gt;&lt;/a&gt;$ ip -4 rule add iif vrf-customer1 lookup customer1
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-3"&gt;&lt;/a&gt;$ ip -6 rule add oif vrf-customer1 lookup customer1
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-4"&gt;&lt;/a&gt;$ ip -6 rule add iif vrf-customer1 lookup customer1
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-5"&gt;&lt;/a&gt;
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-6"&gt;&lt;/a&gt;$ ip -4 rule
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-7"&gt;&lt;/a&gt;0:  from all lookup &lt;span class="nb"&gt;local&lt;/span&gt;
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-8"&gt;&lt;/a&gt;32764:      from all iif vrf-customer1 lookup customer1
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-9"&gt;&lt;/a&gt;32765:      from all oif vrf-customer1 lookup customer1
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-10"&gt;&lt;/a&gt;32766:      from all lookup main
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-11"&gt;&lt;/a&gt;32767:      from all lookup default
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-12"&gt;&lt;/a&gt;
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-13"&gt;&lt;/a&gt;$ ip -6 rule
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-14"&gt;&lt;/a&gt;0:  from all lookup &lt;span class="nb"&gt;local&lt;/span&gt;
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-15"&gt;&lt;/a&gt;32764:      from all oif vrf-customer1 lookup customer1
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-16"&gt;&lt;/a&gt;32765:      from all iif vrf-customer1 lookup customer1
&lt;a name="rest_code_a0c1201c789c4e23972fc32ef51dd7ee-17"&gt;&lt;/a&gt;32766:      from all lookup main
&lt;/pre&gt;&lt;p&gt;To make any use of our VRF we will have to add an device to it. In my case I'll add the only available "physical" device &lt;cite&gt;ens3&lt;/cite&gt;.&lt;/p&gt;
&lt;pre class="code shell"&gt;&lt;a name="rest_code_85c276d6a9394769ab73c64431c764be-1"&gt;&lt;/a&gt;$ ip link &lt;span class="nb"&gt;set&lt;/span&gt; ens3 master vrf-customer1
&lt;a name="rest_code_85c276d6a9394769ab73c64431c764be-2"&gt;&lt;/a&gt;$ &lt;span class="c1"&gt;# verify the interface is indeed a member of the VRF&lt;/span&gt;
&lt;a name="rest_code_85c276d6a9394769ab73c64431c764be-3"&gt;&lt;/a&gt;$ ip -br link show master vrf-customer1
&lt;a name="rest_code_85c276d6a9394769ab73c64431c764be-4"&gt;&lt;/a&gt;ens3             DOWN           52:54:00:12:34:56 &amp;lt;BROADCAST,MULTICAST&amp;gt;
&lt;/pre&gt;&lt;p&gt;Now that we've an interface to receive send send packets with it we should consider adding an IP-Address to it. Since IPv6 is enabled per default we don't need to configure a LL-Address for that protocol.&lt;/p&gt;
&lt;pre class="code shell"&gt;&lt;a name="rest_code_03361c8059d649e3823e727ab9507fef-1"&gt;&lt;/a&gt;$ &lt;span class="c1"&gt;# add an IP to the interface&lt;/span&gt;
&lt;a name="rest_code_03361c8059d649e3823e727ab9507fef-2"&gt;&lt;/a&gt;$ ip addr add 10.0.0.1/24 dev ens3
&lt;a name="rest_code_03361c8059d649e3823e727ab9507fef-3"&gt;&lt;/a&gt;$ ip route show table customer1
&lt;a name="rest_code_03361c8059d649e3823e727ab9507fef-4"&gt;&lt;/a&gt;&lt;span class="nb"&gt;local&lt;/span&gt; 10.0.0.1 dev ens3  proto kernel  scope host  src 10.0.0.1
&lt;/pre&gt;&lt;p&gt;Seeing a route like that might confuse the average linux user. Those routes usually exist within the local table which you can check via &lt;cite&gt;ip route show table local&lt;/cite&gt;&lt;/p&gt;
&lt;p&gt;The route to the /24 we've added is still missing from the interface. Why is that?
You'll have to change the state of the interface to "UP":&lt;/p&gt;
&lt;pre class="code shell"&gt;&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-1"&gt;&lt;/a&gt;$ ip link &lt;span class="nb"&gt;set&lt;/span&gt; ens3 up
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-2"&gt;&lt;/a&gt;$ ip route show table customer1
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-3"&gt;&lt;/a&gt;broadcast 10.0.0.0 dev ens3  proto kernel  scope link  src 10.0.0.1
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-4"&gt;&lt;/a&gt;10.0.0.0/24 dev ens3  proto kernel  scope link  src 10.0.0.1
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-5"&gt;&lt;/a&gt;&lt;span class="nb"&gt;local&lt;/span&gt; 10.0.0.1 dev ens3  proto kernel  scope host  src 10.0.0.1
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-6"&gt;&lt;/a&gt;broadcast 10.0.0.255 dev ens3  proto kernel  scope link  src 10.0.0.1
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-7"&gt;&lt;/a&gt;
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-8"&gt;&lt;/a&gt;
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-9"&gt;&lt;/a&gt;$ ip -6 route show table customer1
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-10"&gt;&lt;/a&gt;&lt;span class="nb"&gt;local&lt;/span&gt; fe80::5054:ff:fe12:3456 dev lo  proto none  metric &lt;span class="m"&gt;0&lt;/span&gt;  pref medium
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-11"&gt;&lt;/a&gt;fe80::/64 dev ens3  proto kernel  metric &lt;span class="m"&gt;256&lt;/span&gt;  pref medium
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-12"&gt;&lt;/a&gt;ff00::/8 dev vrf-customer1  metric &lt;span class="m"&gt;256&lt;/span&gt;  pref medium
&lt;a name="rest_code_697c4076fc5e449ba73418286a788a30-13"&gt;&lt;/a&gt;ff00::/8 dev ens3  metric &lt;span class="m"&gt;256&lt;/span&gt;  pref medium
&lt;/pre&gt;&lt;p&gt;suddenly routes \o/&lt;/p&gt;&lt;/div&gt;</description><category>iproute2</category><category>linux</category><category>routing</category><category>vrf</category><guid>https://andir.github.io/posts/linux-ip-vrf/</guid><pubDate>Tue, 14 Jun 2016 17:00:00 GMT</pubDate></item></channel></rss>