<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Some notes I like to keep around">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Weird random notes</title>
<link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="assets/css/code.css" rel="stylesheet" type="text/css">
<link href="assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="assets/css/theme.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://andir.github.io/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/saltstack-ansible-puppet-how-can-we-share-data/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://andir.github.io/">

                <span id="blog-title">Weird random notes</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/saltstack-ansible-puppet-how-can-we-share-data/" class="u-url">SaltStack, Ansible, Puppet, … how can we share data between servers?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Andreas Rammhold
            </span></p>
            <p class="dateline"><a href="posts/saltstack-ansible-puppet-how-can-we-share-data/" rel="bookmark"><time class="published dt-published" datetime="2017-04-22T16:50:00Z" title="2017-04-22 16:50">2017-04-22 16:50</time></a></p>
                <p class="commentline">
        
    <a href="posts/saltstack-ansible-puppet-how-can-we-share-data/#disqus_thread" data-disqus-identifier="cache/posts/saltstack-ansible-puppet-how-do-you-share-data.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>WARNING: This is still a draft somewhat..</p>
<p>Lately I've been depressed by the lack of automation in my life or really in
the projects I take part in.</p>
<p>Most of my stuff is not hosted on AWS, Azure, Digitalocean or other big "cloud"
players. That is due to multiple reasons:</p>
<blockquote>
<ul class="simple">
<li>We may have hardware, rack, power and network capacity available which is
basically for free.</li>
<li>We might need physical connectivity to the machine - e.g. connecting to a
local WiFi mesh network, a beamer, some audio equipment and so on…</li>
<li>We want to remain in control of our data. That means we are not going to
trust some random internet business.</li>
<li>It is cheaper, even if you've to pay for the servers that are running 24/7.
This might not be true for a website that sells boat trips on the Atlantic
Ocean and gets high traffic spikes every 2nd Sunday from April to December
but for our scenarios it works quite well.</li>
</ul>
</blockquote>
<p>At the office I've been using puppet more then six years and I'm quite happy
with it. In the local Freifunk-Community (<a class="reference external" href="https://darmstadt.freifunk.net">https://darmstadt.freifunk.net</a>) we
are using SaltStack. For my personal infrastructure (E-Mail, Webhosting, random
docker containers, pastebin, dn42, …) I'm using Ansible (<a class="reference external" href="https://ansible.com">https://ansible.com</a>).</p>
<p>Neither of those deployments are very trivial, they are probably just the
average project for either of those tools.</p>
<p>A few weeks back I and a few others started writing SaltStack states for an
IRC-Network that we are running. If you think about automating the deployment
of IRCd's it is rather easier. Create a VM, install your favorite flavor of
linux, install build dependencies for the IRCd of your choice and
generate the configuration. That's basically it.</p>
<p>We've been using TLS in our network for about 10 years now. (Both user and
server2server communication). Since it wasn't and still is not desirable to buy
wildcard certificates or share certificates between servers we are running our
own CA (including OCSP service etc.). With the switch to automated server
configuration we also want to deploy LetsEncrypt - actually LetsEncrypt
encouraged us to start using some kind of automation since humans aren't
reliable and having to jupe a server every 3 months because the admin still
didn't configure a LetsEncrypt cronjob is not what we are after.</p>
<p>So I started out writing some states and a Vagrantfile
(<a class="reference external" href="https://gist.github.com/andir/2188da38904557a58cd7df29fd277275">https://gist.github.com/andir/2188da38904557a58cd7df29fd277275</a>) for easier
testing of the whole stack. After tackling a few issues with Vagrant and
different <cite>boxes</cite> (as vagrant calls VM images) everything looked fine.</p>
<p>We basically have a zoo of VMs on our laptops wich simulate the production
network. At least so we thought.</p>
<p>For the links between the IRCDs we are using TLS. So far we did exchange
fingerprints, manually add them to the <cite>ircd.conf</cite>, <cite>/quote rehash</cite> and off you
go.</p>
<p>When you automate the deployment you also automate the configuration of links
between your servers. While you can configure <cite>send_password</cite> and
<cite>receive_password</cite> since what I do know when that isn't what we want to rely on
when sending chat messages around the globe. So we still need to exchange
certificate fingerprints. One might say that <cite>TLSA</cite> records are made for that
but I wonder why I can't use the already verified connection between my Salt
Master and the Salt Minion. If you query DNS for TLSA records it requires your
DNS to be up, DNSSEC to work, your local resolver to have a copy of the root
dns zone or an upstream resolver that (hopefully) verifies DNSSEC - unlike
OpenDNS.</p>
<p>Since we are also running our own DNS Servers adding them as a dependency isn't
really a great idea. We might be recovering from the death of some parts of the
infrastructure. The only reasonable approach to me is to use the authenticated
relationship from minion and master to exchange public keys, fingerprints etc.</p>
<p>While I'm currently focusing on exchanging certificate fingerprints and/or
public keys this applies to a bunch of scenarios you might come acress when you
decide to drop all shared secrets and generate them on your servers. A few of
those could be:</p>
<blockquote>
<ul class="simple">
<li>Generating and exchanging TSIG keys for nsupdate between your DNS Servers
and minions.</li>
<li>Communicating a shared secret for database access, borg backups, …</li>
<li>Distributing SSHFPs between your servers (local verification, publishing
them to DNS as SSHFP records,…)</li>
<li>Trust bootstrapping (after minion key verification) for any kind of internal
secret database</li>
</ul>
</blockquote>
<p>With SaltStack you've a few options to transfer data from a minion to the master / other minions:</p>
<blockquote>
<ul class="simple">
<li>use the Mine to export data</li>
<li>use grains</li>
<li>use pillars (with pre-generated certificates, keys, …) -&gt; not the desired solution</li>
<li>trigger events with custom context</li>
<li>use a vault</li>
</ul>
</blockquote>
<p>In puppet you could use exported ressources, in Ansible you could write to some
kind of custom api without much overhead or query/configure the other side
on-demand since a single run isn't restricted to a single server.</p>
<p>Puppet has solved the issue for many years - people tend to not like puppet for
various reasons. Maybe because it feels like programming?</p>
<div class="section" id="using-the-salt-mine">
<h2>Using the Salt Mine</h2>
<p>The Salt Mine is a handy construct when it comes to exporting data from a node
as long as that data only exists as some kind of list or with a very low
cardinality. Also it only makes sense if the data is mostly static and doesn't
change. Changes to the exported data (e.g. another information, removal of
information, …) require changes to the minion configuration. This isn't really
practical if you are trying to write modular states where not everything is
hard-wired with another state.</p>
<p>For reference this is how you would export information about a certificate:</p>
<pre class="code yaml"><a name="rest_code_f45d57cf70424d58a71058a0b78f77f4-1"></a><span class="l l-Scalar l-Scalar-Plain">mine_functions</span><span class="p p-Indicator">:</span>
<a name="rest_code_f45d57cf70424d58a71058a0b78f77f4-2"></a>  <span class="l l-Scalar l-Scalar-Plain">my_awesome_certificate</span><span class="p p-Indicator">:</span>
<a name="rest_code_f45d57cf70424d58a71058a0b78f77f4-3"></a>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mine_function</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tls.cert_info</span>
<a name="rest_code_f45d57cf70424d58a71058a0b78f77f4-4"></a>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/etc/letsencrypt/live/.../cert.pem</span>
</pre>
<p>This has to be deployed on each minion and you probably also have to restart the minion when changeing the file.</p>
<p>More information on the salt mine can be found at <a class="reference external" href="https://docs.saltstack.com/en/latest/topics/mine/">https://docs.saltstack.com/en/latest/topics/mine/</a>.</p>
</div>
<div class="section" id="trying-to-export-data-via-grains">
<h2>Trying to export data via Grains</h2>
<p>I'm not going to get into the details or provide a example configuration here.
I've written a bunch of grains and they just work. The limitation is that you
can't really attribute them. So you can't tell your custom grains what to
export without changing the code or introducing custom configuration files,
adding stuff to the minion config etc.. While this approach would automatically
propagate new certificate fingerprints, public keys, … you still have to use
the Salt Mine to actually export them.  Which isn't that bad.</p>
<p>The lack of configuration options for custom grains kills this approach for me.</p>
</div>
<div class="section" id="pillars">
<h2>Pillars</h2>
<p>LOLNOPE. Using pillars would require manual collection of fingerprints or (even
worse) central management of all the certificates.</p>
<p>This simply doesn't work for me.</p>
</div>
<div class="section" id="using-a-custom-event">
<h2>Using a custom event</h2>
<p>This is what seems to be a promising but ephemeral approach to the issue.</p>
<p>The basic idea is:</p>
<blockquote>
<ul>
<li>
<p class="first">Create the public-/private key pair on the minion.</p>
</li>
<li>
<p class="first">On changes to that fail (creation, key rollover, new certificate, …) execute
a script with the filename as argument</p>
</li>
<li>
<p class="first">The (bash) script then extracts the information we want from the file.
(using <cite>openssl</cite> or other command line tools) and publishes those
information using something like</p>
<pre class="code bash"><a name="rest_code_9c5fc113423d4728a28b21b82d3d4a1e-1"></a><span class="sb">`</span>salt-call event.send my/custom/event/certificate-changed <span class="s1">'{"certfp": "ABCDEF01234567890…"}'</span><span class="sb">`</span>
</pre>
</li>
</ul>
</blockquote>
<p>In order to use the "published" fingerprint other minions must be up, running
and listening to those events. Otherwise the information is lost and nobody
cares.</p>
<p>This approach only works if we figure out how to store the fingerprints - after
receiving an event.</p>
<p>It basically sucks as bad as the others but we might be able to configure the
links after randomly restarting salt-minions and running <cite>salt '*' state.apply</cite> …</p>
</div>
<div class="section" id="using-a-vault">
<h2>Using a vault</h2>
<p>At the time of this writing this seems to be a valid option. I've not tried it
yet. There will be an update on this soon (tm).</p>
<p>Reading of the vault seems to be rather easy. You can also write to it but only
using infromation that is availbe during state-rendering. So I'm not sure what
the benefit is. One could probably combine this with the event approach to
store the public keys of the minions in the vault by listening to key events on
the master.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>This world sucks. We need better tools :/</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/juniper-config-recovery-mcd-coredump/" class="u-url">Juniper MCD decided to coredump on commit and rollback</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Andreas Rammhold
            </span></p>
            <p class="dateline"><a href="posts/juniper-config-recovery-mcd-coredump/" rel="bookmark"><time class="published dt-published" datetime="2016-11-08T15:00:00Z" title="2016-11-08 15:00">2016-11-08 15:00</time></a></p>
                <p class="commentline">
        
    <a href="posts/juniper-config-recovery-mcd-coredump/#disqus_thread" data-disqus-identifier="cache/posts/juniper-invalid-config-recovery.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>On a Juniper EX3300 a colleague of mine entered an invalid statement:</p>
<pre class="code shell"><a name="rest_code_49235dfa72f94f99becb67cfb5ff764a-1"></a>interface-range some_ports <span class="o">{</span>
<a name="rest_code_49235dfa72f94f99becb67cfb5ff764a-2"></a>    member ge0/0/2<span class="p">;</span>
<a name="rest_code_49235dfa72f94f99becb67cfb5ff764a-3"></a>    member-range ge-0/0/0 to ge-0/0/1<span class="p">;</span>
<a name="rest_code_49235dfa72f94f99becb67cfb5ff764a-4"></a><span class="o">}</span>
</pre>
<p>The <cite>member ge0/0/2</cite> is missing a <cite>-</cite> between <cite>ge</cite> and <cite>0/0/2</cite>. Juniper (for whatever reason) accepted the input but <cite>mcd</cite> decided to segfault when asked to delete or rollback the configuration.</p>
<pre class="code shell"><a name="rest_code_2983cccfae69446a9a771b327a0c6f6e-1"></a>pid <span class="m">75982</span> <span class="o">(</span>mgd<span class="o">)</span>, uid <span class="m">0</span>: exited on signal <span class="m">11</span> <span class="o">(</span>core dumped<span class="o">)</span>
</pre>
<p>Recovering from that case is actually not that hard. You just know the right command(s) ;-)</p>
<p>You can load an older configuration via the <cite>load override &lt;config file&gt;</cite> command. I did also try the <cite>load replace &lt;config file&gt;</cite> command but that also segfaulted..</p>
<pre class="code shell"><a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-1"></a>andi@foo# load override ?
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-2"></a>Possible completions:
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-3"></a>  &lt;filename&gt;           Filename <span class="o">(</span>URL, local, remote, or floppy<span class="o">)</span>
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-4"></a>  db/                  Last changed: Oct <span class="m">27</span> <span class="m">10</span>:44:35
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-5"></a>  juniper.conf+.gz     Size: <span class="m">6000</span>, Last changed: Nov <span class="m">08</span> <span class="m">15</span>:12:55
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-6"></a>  juniper.conf.1.gz    Size: <span class="m">5913</span>, Last changed: Jun <span class="m">30</span> <span class="m">13</span>:36:52
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-7"></a>  juniper.conf.2.gz    Size: <span class="m">5881</span>, Last changed: Jun <span class="m">30</span> <span class="m">12</span>:59:25
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-8"></a>  juniper.conf.3.gz    Size: <span class="m">5280</span>, Last changed: Jun <span class="m">30</span> <span class="m">12</span>:54:02
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-9"></a>  <span class="o">[</span>...<span class="o">]</span>
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-10"></a><span class="o">{</span>master:0<span class="o">}[</span>edit<span class="o">]</span>
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-11"></a>andi@foo# load override juniper.conf+.gz
<a name="rest_code_fe93c0aada6146dcaf2fe7143f0d1ede-12"></a>load <span class="nb">complete</span>
</pre>
<p>In my case the <cite>juniper.conf+.gz</cite> was the desired config file. I recommend inspecting those files before loading them (they are stored in <cite>/config/</cite>).</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/linux-ip-vrf-systemd-networkd/" class="u-url">Using VRFs with linux and systemd-networkd</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Andreas Rammhold
            </span></p>
            <p class="dateline"><a href="posts/linux-ip-vrf-systemd-networkd/" rel="bookmark"><time class="published dt-published" datetime="2016-10-09T13:00:00Z" title="2016-10-09 13:00">2016-10-09 13:00</time></a></p>
                <p class="commentline">
        
    <a href="posts/linux-ip-vrf-systemd-networkd/#disqus_thread" data-disqus-identifier="cache/posts/linux-vrf-with-systemd.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>While working on a systemd-networkd patch to implement (at least basic) VRF interfaces I did write <a class="reference external" href="posts/linux-ip-vrf/">my other post</a>. This post should give you a brief example on how you can create a VRF with systemd-networkd.</p>
<p>At this point it really only created the interfaces and enslaves potential customer interfaces to a given VRF.</p>
<p>You still have to implement all the <cite>ip rule</cite>-stuff yourself. For example a <cite>systemd.unit</cite> file might be the right approach which is executed/started after the network is "up".</p>
<p>First you've to create the systemd.netdev <cite>vrf-customer1.netdev</cite> file:</p>
<script src="https://gist.github.com/146803a9343e04fffabc8e7105dff3cd.js"></script><noscript>
<pre class="literal-block">
[NetDev]
Name=vrf-customer1
Kind=vrf

[VRF]
TableId=42
</pre>
</noscript>
<p>After restarting <cite>systemd-networkd</cite> with <cite>systemctl restart systemd-networkd</cite> you should see the corresponding interface:</p>
<pre class="code shell"><a name="rest_code_7f467dc80b4c47248f85ba80459c0523-1"></a>$ ip -d link show dev vrf-customer1
<a name="rest_code_7f467dc80b4c47248f85ba80459c0523-2"></a><span class="m">9</span>: vrf-customer1: &lt;NOARP,MASTER&gt; mtu <span class="m">1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class="m">1000</span>
<a name="rest_code_7f467dc80b4c47248f85ba80459c0523-3"></a>    link/ether <span class="m">02</span>:74:c7:e1:de:64 brd ff:ff:ff:ff:ff:ff promiscuity <span class="m">0</span>
<a name="rest_code_7f467dc80b4c47248f85ba80459c0523-4"></a>    vrf table <span class="m">42</span> addrgenmode eui64 numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span>
</pre>
<p>Note the last line which states <cite>vrf table 42</cite>.</p>
<p>To add an interface to the VRF you'll have to modify/create the corresponding .network file. This is how the file <cite>/etc/systemd/network/enp0s31f6.network</cite> would look on my notebook:</p>
<script src="https://gist.github.com/ee155492e3af2f83df39b0808fda5718.js"></script><noscript>
<pre class="literal-block">
[Match]
Name=enp0s31f6

[Network]
Address=192.168.0.1/24
VRF=vrf-customer1

</pre>
</noscript>
<p>Restarting <cite>systemd-networkd</cite> again and checking the status using <cite>ip -d link</cite> gives us:</p>
<pre class="code shell"><a name="rest_code_e168d6bd19e44d0dae52058c0f74e8fb-1"></a><span class="nv">$ip</span> -d link show  dev enp0s31f6
<a name="rest_code_e168d6bd19e44d0dae52058c0f74e8fb-2"></a><span class="m">3</span>: enp0s31f6: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="m">1500</span> qdisc fq_codel master vrf-customer1 state DOWN mode DEFAULT group default qlen <span class="m">1000</span>
<a name="rest_code_e168d6bd19e44d0dae52058c0f74e8fb-3"></a> link/ether <span class="m">50</span>:7b:9d:cf:34:dc brd ff:ff:ff:ff:ff:ff promiscuity <span class="m">0</span>
<a name="rest_code_e168d6bd19e44d0dae52058c0f74e8fb-4"></a> vrf_slave table <span class="m">42</span> addrgenmode eui64 numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span>
</pre>
<p>Again note the last line which states <cite>vrf_slave table 42</cite>. Also in the first line you can see that it belongs to the VRF <cite>vrf-customer</cite>.</p>
<p>And that is all for now. You still have to add the <cite>ip rule</cite> commands in some way or another (there is no support in systemd-networkd yet and I did not have a good idea without inventing <cite>ip rule</cite> management in systemd).</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/linux-ip-vrf/" class="u-url">Using VRFs with linux</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Andreas Rammhold
            </span></p>
            <p class="dateline"><a href="posts/linux-ip-vrf/" rel="bookmark"><time class="published dt-published" datetime="2016-06-14T17:00:00Z" title="2016-06-14 17:00">2016-06-14 17:00</time></a></p>
                <p class="commentline">
        
    <a href="posts/linux-ip-vrf/#disqus_thread" data-disqus-identifier="cache/posts/linux-ip-vrf.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Ever since I've heard about VRF support (or VRF-lite like it is called in Documentation/network/vrf.txt) I wanted to start tinkering with it.
Since the topic is currently only covered in the previously mentioned linux kernel documentation I thought it would be a good idea to post some notes.</p>
<p>It basically boils down to adding an VRF interface and creating two <cite>ip rule</cite>-entries.</p>
<p>I'm using a local VM with ArchLinux since the VRF feature seems to require a rather recent kernel. My experience with kernels below version 4.6 weren't that great.</p>
<pre class="code shell"><a name="rest_code_c58481ab2f804150b7937152d115dcfd-1"></a>$ ip -br link <span class="c1"># this is where we are start off</span>
<a name="rest_code_c58481ab2f804150b7937152d115dcfd-2"></a>lo               UNKNOWN        <span class="m">00</span>:00:00:00:00:00 &lt;LOOPBACK,UP,LOWER_UP&gt;
<a name="rest_code_c58481ab2f804150b7937152d115dcfd-3"></a>ens3             DOWN           <span class="m">52</span>:54:00:12:34:56 &lt;BROADCAST,MULTICAST&gt;
</pre>
<p>Now are adding a new interface named <cite>vrf-customer1</cite> with the table <cite>customer1</cite> assigned to it.
The table parameter is used to place routes from your devices within the VRF into the right routing table</p>
<pre class="code shell"><a name="rest_code_03a8f4b9c73e4ad0854057cbc90443d3-1"></a>$ ip link add vrf-customer1 <span class="nb">type</span> vrf table customer1
<a name="rest_code_03a8f4b9c73e4ad0854057cbc90443d3-2"></a>
<a name="rest_code_03a8f4b9c73e4ad0854057cbc90443d3-3"></a>$ ip -d link show vrf-customer1 <span class="c1"># verify that the interface indeed exists and has the correct table assigned to it</span>
<a name="rest_code_03a8f4b9c73e4ad0854057cbc90443d3-4"></a><span class="m">4</span>: vrf-customer1: &lt;NOARP,MASTER&gt; mtu <span class="m">1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class="m">1000</span>
<a name="rest_code_03a8f4b9c73e4ad0854057cbc90443d3-5"></a>    link/ether ca:22:59:ba:05:da brd ff:ff:ff:ff:ff:ff promiscuity <span class="m">0</span>
<a name="rest_code_03a8f4b9c73e4ad0854057cbc90443d3-6"></a>    vrf table <span class="m">100</span> addrgenmode eui64
</pre>
<p>Next: redirect the traffic from and to the vrf to the customer1 table and verify the rules are indeed as expected:</p>
<pre class="code shell"><a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-1"></a>$ ip -4 rule add oif vrf-customer1 lookup customer1
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-2"></a>$ ip -4 rule add iif vrf-customer1 lookup customer1
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-3"></a>$ ip -6 rule add oif vrf-customer1 lookup customer1
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-4"></a>$ ip -6 rule add iif vrf-customer1 lookup customer1
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-5"></a>
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-6"></a>$ ip -4 rule
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-7"></a><span class="m">0</span>:  from all lookup <span class="nb">local</span>
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-8"></a><span class="m">32764</span>:      from all iif vrf-customer1 lookup customer1
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-9"></a><span class="m">32765</span>:      from all oif vrf-customer1 lookup customer1
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-10"></a><span class="m">32766</span>:      from all lookup main
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-11"></a><span class="m">32767</span>:      from all lookup default
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-12"></a>
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-13"></a>$ ip -6 rule
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-14"></a><span class="m">0</span>:  from all lookup <span class="nb">local</span>
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-15"></a><span class="m">32764</span>:      from all oif vrf-customer1 lookup customer1
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-16"></a><span class="m">32765</span>:      from all iif vrf-customer1 lookup customer1
<a name="rest_code_3f726a3149a04d99b00dc7ac24c85b27-17"></a><span class="m">32766</span>:      from all lookup main
</pre>
<p>To make any use of our VRF we will have to add an device to it. In my case I'll add the only available "physical" device <cite>ens3</cite>.</p>
<pre class="code shell"><a name="rest_code_189eca459b534c238de7bb52b4c05aff-1"></a>$ ip link <span class="nb">set</span> ens3 master vrf-customer1
<a name="rest_code_189eca459b534c238de7bb52b4c05aff-2"></a>$ <span class="c1"># verify the interface is indeed a member of the VRF</span>
<a name="rest_code_189eca459b534c238de7bb52b4c05aff-3"></a>$ ip -br link show master vrf-customer1
<a name="rest_code_189eca459b534c238de7bb52b4c05aff-4"></a>ens3             DOWN           <span class="m">52</span>:54:00:12:34:56 &lt;BROADCAST,MULTICAST&gt;
</pre>
<p>Now that we've an interface to receive send send packets with it we should consider adding an IP-Address to it. Since IPv6 is enabled per default we don't need to configure a LL-Address for that protocol.</p>
<pre class="code shell"><a name="rest_code_54d7c06d5c624933a14f6ca352b1bb88-1"></a>$ <span class="c1"># add an IP to the interface</span>
<a name="rest_code_54d7c06d5c624933a14f6ca352b1bb88-2"></a>$ ip addr add <span class="m">10</span>.0.0.1/24 dev ens3
<a name="rest_code_54d7c06d5c624933a14f6ca352b1bb88-3"></a>$ ip route show table customer1
<a name="rest_code_54d7c06d5c624933a14f6ca352b1bb88-4"></a><span class="nb">local</span> <span class="m">10</span>.0.0.1 dev ens3  proto kernel  scope host  src <span class="m">10</span>.0.0.1
</pre>
<p>Seeing a route like that might confuse the average linux user. Those routes usually exist within the local table which you can check via <cite>ip route show table local</cite></p>
<p>The route to the /24 we've added is still missing from the interface. Why is that?
You'll have to change the state of the interface to "UP":</p>
<pre class="code shell"><a name="rest_code_763608e008b3408f97c911e333e3ad1a-1"></a>$ ip link <span class="nb">set</span> ens3 up
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-2"></a>$ ip route show table customer1
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-3"></a>broadcast <span class="m">10</span>.0.0.0 dev ens3  proto kernel  scope link  src <span class="m">10</span>.0.0.1
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-4"></a><span class="m">10</span>.0.0.0/24 dev ens3  proto kernel  scope link  src <span class="m">10</span>.0.0.1
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-5"></a><span class="nb">local</span> <span class="m">10</span>.0.0.1 dev ens3  proto kernel  scope host  src <span class="m">10</span>.0.0.1
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-6"></a>broadcast <span class="m">10</span>.0.0.255 dev ens3  proto kernel  scope link  src <span class="m">10</span>.0.0.1
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-7"></a>
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-8"></a>
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-9"></a>$ ip -6 route show table customer1
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-10"></a><span class="nb">local</span> fe80::5054:ff:fe12:3456 dev lo  proto none  metric <span class="m">0</span>  pref medium
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-11"></a>fe80::/64 dev ens3  proto kernel  metric <span class="m">256</span>  pref medium
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-12"></a>ff00::/8 dev vrf-customer1  metric <span class="m">256</span>  pref medium
<a name="rest_code_763608e008b3408f97c911e333e3ad1a-13"></a>ff00::/8 dev ens3  metric <span class="m">256</span>  pref medium
</pre>
<p>suddenly routes \o/</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/isc-dhcpd-multiple-classes/" class="u-url">Using multiple client classes with ISC DHCPd</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Andreas Rammhold
            </span></p>
            <p class="dateline"><a href="posts/isc-dhcpd-multiple-classes/" rel="bookmark"><time class="published dt-published" datetime="2016-05-23T11:00:00Z" title="2016-05-23 11:00">2016-05-23 11:00</time></a></p>
                <p class="commentline">
        
    <a href="posts/isc-dhcpd-multiple-classes/#disqus_thread" data-disqus-identifier="cache/posts/isc-dhcpd-multiple-classes.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Since the internet is lacking examples of how to use multiple classes with a single pool here is one:</p>
<pre class="code nginx"><a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-1"></a><span class="k">class</span> <span class="s">"mac-filtered-clients"</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-2"></a><span class="p">{</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-3"></a>    <span class="kn">match</span> <span class="s">binary-to-ascii</span> <span class="s">(16,</span> <span class="mi">8</span><span class="s">,</span> <span class="s">":",</span> <span class="s">substring(hardware,</span> <span class="mi">1</span><span class="s">,</span> <span class="mi">6</span><span class="s">))</span><span class="p">;</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-4"></a><span class="p">}</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-5"></a>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-6"></a><span class="k">subclass</span> <span class="s">"mac-filtered-clients"</span> <span class="s">"50:7b:00:00:00:00"</span><span class="p">;</span> <span class="c1"># some cool host!</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-7"></a>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-8"></a><span class="k">class</span> <span class="s">"J-client"</span> <span class="p">{</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-9"></a>    <span class="kn">spawn</span> <span class="s">with</span> <span class="s">option</span> <span class="s">agent.circuit-id</span><span class="p">;</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-10"></a>    <span class="kn">match</span> <span class="s">if</span> <span class="s">(substring(option</span> <span class="s">agent.circuit-id,</span> <span class="mi">30</span><span class="s">,</span> <span class="mi">9</span><span class="s">)</span> <span class="p">=</span> <span class="s">"foo-bar")</span><span class="p">;</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-11"></a>    <span class="kn">lease</span> <span class="s">limit</span> <span class="mi">1</span><span class="p">;</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-12"></a><span class="p">}</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-13"></a>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-14"></a><span class="k">subnet</span> <span class="mi">192</span><span class="s">.168.0.0</span> <span class="mi">255</span><span class="s">.255.0.0</span> <span class="p">{</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-15"></a>     <span class="kn">pool</span> <span class="p">{</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-16"></a>          <span class="kn">range</span> <span class="mi">192</span><span class="s">.168.0.10</span> <span class="mi">192</span><span class="s">.168.0.150</span><span class="p">;</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-17"></a>          <span class="kn">allow</span> <span class="s">members</span> <span class="s">of</span> <span class="s">"J-client"</span><span class="p">;</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-18"></a>          <span class="kn">allow</span> <span class="s">members</span> <span class="s">of</span> <span class="s">"mac-filtered-clients"</span><span class="p">;</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-19"></a>     <span class="p">}</span>
<a name="rest_code_be5adfe0dd1f4a1a99142f8407b81199-20"></a><span class="p">}</span>
</pre>
<p>This isn't very special compared to a setup with just a single class but it can be confusing since debugging classes is a pita.. One pitfall I did run into was using the byte representation of the mac-addresses (without the quotes) and using <code>match hardware;</code>. The example above works for me (tm).</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/postgresql-tmpfs-with-sytemdsocket-activation-for-local-ephemeral-data-during-development/" class="u-url">Postgresql-tmpfs with systemd.socket-activation for local (ephemeral) data during development</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Andreas Rammhold
            </span></p>
            <p class="dateline"><a href="posts/postgresql-tmpfs-with-sytemdsocket-activation-for-local-ephemeral-data-during-development/" rel="bookmark"><time class="published dt-published" datetime="2016-04-22T09:50:09Z" title="2016-04-22 09:50">2016-04-22 09:50</time></a></p>
                <p class="commentline">
        
    <a href="posts/postgresql-tmpfs-with-sytemdsocket-activation-for-local-ephemeral-data-during-development/#disqus_thread" data-disqus-identifier="cache/posts/postgresql-tmpfs-with-sytemdsocket-activation-for-local-ephemeral-data-during-development.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>During development of database related stuff you commonly run into the "issue" (or non-issue depending on your taste) of running a local database server - or multiple of those.</p>
<p>In my case I have to run a local postgresql server on my notebook. I asked myself: I'm not always developing on that piece of software, and I do not always require or want a local postgresql server. What can I do about that?!?</p>
<p>On top of that using my precious SSD to store data I am going to delete anyway souds like a waste (or money). In my development environment I can and want to safely wipe the data often. Also most of the database load comes from running test cases anyway. That stuff doesn't need to end up on my (slow, compared to RAM) disk. Using a tmpfs for that kind of stuff sounds much saner to me.</p>
<p>The part of running a repetitive clean database setup sounded like the use case for a container based thing. These days docker is pretty "hot" and it solves the issue of distributing re-useable images. There is an official postgresql image on docker hub for various versions of postgresql. I've simply build a new image based on that. It is available on docker hub (<a class="reference external" href="https://hub.docker.com/r/andir/postgresql-tmpfs/">https://hub.docker.com/r/andir/postgresql-tmpfs/</a>) or if you prefer to build it on your own you can download the Dockerfile on GitHub (<a class="reference external" href="https://github.com/andir/postgresql-tmpfs">https://github.com/andir/postgresql-tmpfs</a>).</p>
<p>Now that we are past the introductional blabla here are the systemd unit files I'm using to achieve this:</p>
<script src="https://gist.github.com/d8307bcead6d83945db462698163ff40.js"></script><noscript>
<pre class="literal-block">
[Service]
ExecStartPre=-/usr/bin/docker rm psql-tmpfs
ExecStart=/usr/bin/docker run --rm --shm-size=2g -name psql-tmpfs -p 127.0.0.1:5434:5432 -t andir/postgresql-tmpfs
ExecStartPost=/bin/sleep 15
ExecStop=/usr/bin/docker stop psql-tmpfs

</pre>
</noscript>
<p>You can either put those unit files in <cite>/etc/systemd/system</cite> or install them as systemd-user units in <cite>~/.config/systemd/user</cite>.</p>
<pre class="code bash"><a name="rest_code_ab0f83cec1b54498b9a461aa87b311ec-1"></a>systemctl daemon-reload
<a name="rest_code_ab0f83cec1b54498b9a461aa87b311ec-2"></a>systemctl <span class="nb">enable</span> postgresql-docker.socket
</pre>
<p>If you try to connect to the postgresql server (<code>nc 127.0.0.1 5432</code>) you can observe the container while it is starting (<code>journalctl -f</code>).</p>
<p>The default username, password and database name is <cite>postgres</cite>. You can change that by modifying the startup arguments of the docker container. Those are documented at <a class="reference external" href="https://hub.docker.com/_/postgres/">https://hub.docker.com/_/postgres/</a>.</p>
<p>Happy data trashing \o/</p>
<p>P.S.: If you've an idea on how to stop the service after x minutes of inactivity please let me know. Stopping the service manually isn't really what I'm after.</p>
</div>
    </div>
    </article>
</div>



        
       <script>var disqus_shortname="andir";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2017         <a href="mailto:andreas@rammhold.de">Andreas Rammhold</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/jquery.min.js"></script><script src="assets/js/bootstrap.min.js"></script><script src="assets/js/moment-with-locales.min.js"></script><script src="assets/js/fancydates.js"></script><script src="assets/js/jquery.colorbox-min.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
